using System.Text;
using Waher.Content.Xml;

namespace Waher.Security.TOTP.Test
{
	[TestClass]
	public sealed class TotpTests
	{
		[TestMethod]
		[DataRow(HashFunction.SHA1, 8, 30, "1970-01-01T00:00:59Z", "12345678901234567890", 94287082)]
		[DataRow(HashFunction.SHA256, 8, 30, "1970-01-01T00:00:59Z", "12345678901234567890123456789012", 46119246)]
		[DataRow(HashFunction.SHA512, 8, 30, "1970-01-01T00:00:59Z", "1234567890123456789012345678901234567890123456789012345678901234", 90693936)]
		[DataRow(HashFunction.SHA1, 8, 30, "2005-03-18T01:58:29Z", "12345678901234567890", 07081804)]
		[DataRow(HashFunction.SHA256, 8, 30, "2005-03-18T01:58:29Z", "12345678901234567890123456789012", 68084774)]
		[DataRow(HashFunction.SHA512, 8, 30, "2005-03-18T01:58:29Z", "1234567890123456789012345678901234567890123456789012345678901234", 25091201)]
		[DataRow(HashFunction.SHA1, 8, 30, "2005-03-18T01:58:31Z", "12345678901234567890", 14050471)]
		[DataRow(HashFunction.SHA256, 8, 30, "2005-03-18T01:58:31Z", "12345678901234567890123456789012", 67062674)]
		[DataRow(HashFunction.SHA512, 8, 30, "2005-03-18T01:58:31Z", "1234567890123456789012345678901234567890123456789012345678901234", 99943326)]
		[DataRow(HashFunction.SHA1, 8, 30, "2009-02-13T23:31:30Z", "12345678901234567890", 89005924)]
		[DataRow(HashFunction.SHA256, 8, 30, "2009-02-13T23:31:30Z", "12345678901234567890123456789012", 91819424)]
		[DataRow(HashFunction.SHA512, 8, 30, "2009-02-13T23:31:30Z", "1234567890123456789012345678901234567890123456789012345678901234", 93441116)]
		[DataRow(HashFunction.SHA1, 8, 30, "2033-05-18T03:33:20Z", "12345678901234567890", 69279037)]
		[DataRow(HashFunction.SHA256, 8, 30, "2033-05-18T03:33:20Z", "12345678901234567890123456789012", 90698825)]
		[DataRow(HashFunction.SHA512, 8, 30, "2033-05-18T03:33:20Z", "1234567890123456789012345678901234567890123456789012345678901234", 38618901)]
		[DataRow(HashFunction.SHA1, 8, 30, "2603-10-11T11:33:20Z", "12345678901234567890", 65353130)]
		[DataRow(HashFunction.SHA256, 8, 30, "2603-10-11T11:33:20Z", "12345678901234567890123456789012", 77737706)]
		[DataRow(HashFunction.SHA512, 8, 30, "2603-10-11T11:33:20Z", "1234567890123456789012345678901234567890123456789012345678901234", 47863826)]
		public void Test_01_Calculate(HashFunction HashFunction, int NrDigits, int TimeStepSeconds,
			string Timestamp, string Secret, int Password)
		{
			DateTime ParsedTimestamp = XML.ParseDateTime(Timestamp);
			TotpAlgorithm Hotp = new(NrDigits, Encoding.ASCII.GetBytes(Secret), HashFunction, TimeStepSeconds);
			int ComputedPassword = Hotp.Compute(ParsedTimestamp);

			Assert.AreEqual(Password, ComputedPassword);
		}
	}
}
